<!doctype html>
<html lang="en">
  <head>
    <title>WEB</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
      .form-tab { display: none; } 
      .form-tab.active { display: block;}
      .login-wrap {  width: 120%; height: 85%; background: rgba(78, 102, 136, 1); padding: 40px; border-radius: 40px; max-height: 500px;}
      .form-control { width: 100%; background: rgba(147, 147, 147, 0.7); color: #333; border-radius: 20px; }
      .btn-primary  { width: 50%; }
      .btn-success  { width: 30%; height: 80%; background-color: #28a745; border-color: #28a745; }
      .dropdown-toggle { background-color: #007bff; color: #fff; border-radius: 20px; width: 150px; }
      .checkbox-wrap { color: #fff; }
      .checkbox-wrap input { position: relative; top: 2px; }
      .checkmark { background-color: #fff; border-radius: 50%; transition: background-color 0.3s ease;}
      .transfer-column {
      padding: 30px;
      border-radius: 15px;
      text-align: center; 
      min-width: 500px;
      min-height: 400px;
      max-height: 500px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

	</style>
  </head>
  <body class="img js-fullheight" style="background-image: url(images/bg.jpg); background-size: cover; background-position: center; background-attachment: fixed;">
	<section class="ftco-section ftco-degree-bg" style="margin-right: 55px">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-md-12 text-center mb-5">
            <h2 class="heading-section" id="form-title" style=" white-space: nowrap; font-family: 'Arial'; font-size: 80px; font-weight: 1000; margin-left: 70px; margin-bottom: -20px;">SIGN IN</h2>
          </div>
        </div>
        <div class="row justify-content-center">
          <div class="col-md-6 col-lg-4">
            <div class="login-wrap p-0" style="margin-bottom: 90px;">

              <!-- Login Tab -->
              <div id="login-tab" class="form-tab active">
                <h3 class="mb-4 text-center" style="font-family: 'Arial';">Have an account?</h3>
                <form action="#" class="signin-form">
                  <div class="d-flex flex-column align-items-center">
                    <div class="form-group w-75">
                      <input type="text" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="form-group w-75">
                      <input type="password" class="form-control" placeholder="Password" required>
                      <span class="toggle-password" onclick="togglePassword(event)" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#ffffff;">
                        <i class="fa fa-eye" id="toggle-icon"></i>
                      </span>
                    </div>
                    </div>
                  <div class="text-center">
                    <button type="submit" id="show-function" class="form-control btn btn-primary submit px-3">Sign In</button>
                  </div>
                  <div class="form-group d-md-flex" style="margin-top: 20px;">
                    <div class="w-50">
                      <label class="checkbox-wrap checkbox-primary text-md-center">Remember Me
                        <input type="checkbox" checked>
                        <span class="checkmark" style="margin: 35px; margin-top: 1px;"></span>
                      </label>
                    </div>
                    <div class="w-50 text-md-center" id="forgot-password-tab">
                      <a href="#" style="color: #b8ebff;"><u>Forgot Password</u></a>
                    </div>
                  </div>
                </form>
                <p class="w-100 text-center" style="margin-top: -10px;">&mdash; Or don't have an account? &mdash;</p>
                <div class="text-center">
                  <button type="submit" id="show-register" class="form-control btn btn-success submit px-3">REGISTER</button>
                </div>
              </div>

              <!-- Register Tab -->
              <div id="register-tab" class="form-tab">
                <h3 class="mb-4 text-center" style="font-family: 'Arial';">Create an account</h3>
                <form action="#" class="signin-form">
                  <div class="d-flex flex-column align-items-center">
                    <div class="form-group w-75">
                      <input type="text" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="form-group w-75">
                      <input type="text" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="form-group w-75">
                      <input type="password" class="form-control" placeholder="Password" required>
                      <span class="toggle-password" onclick="togglePassword(event)" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#ffffff;">
                        <i class="fa fa-eye" id="toggle-icon"></i>
                      </span>
                    </div>
                    </div>
                  <div class="text-center">
                    <button type="submit" class="form-control btn btn-primary submit px-3">REGISTER</button>
                  </div>
                </form>
                <p class="w-100 text-center" style="margin-top: 20px;">&mdash; Already have an account? &mdash;</p>
                <div class="text-center">
                  <button type="submit" id="show-login" class="form-control btn btn-success submit px-3">SIGN IN</button>
                </div>
              </div>

              <!-- Forgot Password Tab -->
              <div id="forgot-password-panel" class="form-tab">
                <h3 class="mb-4 text-center"  style="font-family: 'Arial';">Forgot Password</h3>
                <form action="#" class="signin-form">
                  <div class="d-flex flex-column align-items-center">
                    <div class="form-group w-75">
                      <input type="text" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="form-group w-75">
                      <input type="text" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="form-group w-75">
                      <input type="password" class="form-control" placeholder="Password" required>
                      <span class="toggle-password" onclick="togglePassword(event)" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#ffffff;">
                        <i class="fa fa-eye" id="toggle-icon"></i>
                      </span>
                    </div>
                    </div>
                  <div class="text-center">
                    <button type="submit" class="form-control btn btn-primary submit px-3">Change Password</button>
                  </div>
                </form>
                <div class="text-center">
                  <button type="submit" id="show-login-forgot" class="form-control btn btn-success submit px-3" style="margin-top: 15px;">SIGN IN</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row justify-content-center">
          <div class="col-md-6 col-lg-4" style="margin-bottom: 90px;">
              
            <!-- Function Tab -->
              <div id="function-tab" class="form-tab">
                <div class="container" style="display: flex; gap: 50px; justify-content: center; align-items: center; margin-left: 30px; margin-top: -100px;">

                  <!-- Station Info -->
                  <div class="transfer-column" style="background-color: #4E6688;">
                    <h4 style="font-size: 34px; color: #ffffff; font-family: 'Arial';">Station Info</h4>
                    <div id="station-list" style="text-align: left; background: #eaffea; padding: 10px; border-radius: 10px; overflow-y: auto; width: 100%; height: 100%; max-height: 300px;">
                      <!-- Station info will be rendered here -->
                    </div>
                  </div>

                  <!-- Transfer Documents -->
                  <div class="transfer-column" style="background-color: #4E6688;">
                    <h4 style="font-size: 34px; color: #ffffff; font-family: 'Arial';">Select Room</h4>
                    <form>
                      <div class="form-group" style="margin-top: 5px; margin-left: 63px; width: 70%; color: #ffffff;">
                        <label>Source Room</label>
                        <select id="source-room" class="form-control" required></select>
                      </div>
                      <div class="form-group" style="margin-top: 5px; margin-left: 63px; width: 70%; color: #ffffff;">
                        <label>Delivery Room</label>
                        <select id="delivery-room" class="form-control" required></select>
                      </div>
                      <button class="btn btn-primary" style="margin-top: 20px; width: 50%;" type="button" onclick="addTransferLog()">Transfer</button>
                    </form>
                  </div>

                  <!-- Transfer Log -->
                  <div class="transfer-column" style="background-color: #4E6688;">
                    <h4 style="font-size: 34px; color: #ffffff; font-family: 'Arial';">Transfer Log</h4>
                    <div id="transfer-log-output" style="text-align: left; background: #eaffea; padding: 10px; border-radius: 10px; overflow-y: auto; width: 100%; height: 100%; max-height: 300px;">
                      <!-- Logs will appear here -->
                    </div>
                  </div>

                </div>
              </div>

              
          </div>
        </div>
        
        <div id="toast" style="
          position: fixed;
          bottom: 30px;
          right: 30px;
          background-color: #333;
          color: #fff;
          padding: 14px 20px;
          border-radius: 8px;
          font-size: 16px;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.5s ease;
          z-index: 9999;
        "></div>

      </div>
    </section>

    <script src="js/jquery.min.js"></script>
    <script src="js/popper.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
   <script>
      const loginTab = document.getElementById('login-tab');
      const registerTab = document.getElementById('register-tab');
      const forgotPasswordTab = document.getElementById('forgot-password-panel');
      const functionTab = document.getElementById('function-tab');
      const formTitle = document.getElementById('form-title');

      // ==== UI Chuyển Tab ====
      document.getElementById('show-register').addEventListener('click', e => {
        e.preventDefault();
        loginTab.classList.remove('active');
        registerTab.classList.add('active');
        formTitle.innerText = 'REGISTER';
      });

      document.getElementById('show-login').addEventListener('click', e => {
        e.preventDefault();
        registerTab.classList.remove('active');
        loginTab.classList.add('active');
        formTitle.innerText = 'SIGN IN';
      });

      document.querySelector('#forgot-password-tab a').addEventListener('click', e => {
        e.preventDefault();
        loginTab.classList.remove('active');
        forgotPasswordTab.classList.add('active');
        formTitle.innerText = 'FORGOT PASSWORD';
        formTitle.style.marginLeft = '180px';
      });

      document.getElementById('show-login-forgot').addEventListener('click', e => {
        e.preventDefault();
        forgotPasswordTab.classList.remove('active');
        loginTab.classList.add('active');
        formTitle.innerText = 'SIGN IN';
        formTitle.style.marginLeft = '70px';
      });

      // ==== Toggle Password ====
      function togglePassword(event) {
        const toggleIcon = event.target;
        const passwordInput = toggleIcon.closest('.form-group').querySelector('input');
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
        toggleIcon.classList.toggle('fa-eye');
        toggleIcon.classList.toggle('fa-eye-slash');
      }

      // ==== Đăng nhập ====
      document.getElementById('show-function').addEventListener('click', async function (e) {
        e.preventDefault();
        const username = loginTab.querySelector('input[placeholder="Username"]').value;
        const password = loginTab.querySelector('input[placeholder="Password"]').value;

        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (res.ok) {
          loginTab.classList.remove('active');
          functionTab.classList.add('active');
          formTitle.innerText = 'TRANSFER DOCUMENT';
          formTitle.style.fontSize = '50px';
          renderStations();
          renderRoomDropdowns();
          loadLogs();
        } else {
          const data = await res.json();
          alert(data.message || 'Login failed');
        }
      });

      // ==== Đăng ký ====
      registerTab.querySelector('form').addEventListener('submit', async e => {
        e.preventDefault();
        const username = registerTab.querySelector('input[placeholder="Username"]').value;
        const email = registerTab.querySelector('input[placeholder="Email"]').value;
        const password = registerTab.querySelector('input[placeholder="Password"]').value;

        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        const data = await res.json();
        if (res.ok) {
          alert('Đăng ký thành công!');
          registerTab.classList.remove('active');
          loginTab.classList.add('active');
          formTitle.innerText = 'SIGN IN';
        } else {
          alert(data.message || 'Đăng ký thất bại!');
        }
      });

      // ==== Quên mật khẩu ====
      forgotPasswordTab.querySelector('form').addEventListener('submit', async e => {
        e.preventDefault();
        const username = forgotPasswordTab.querySelector('input[placeholder="Username"]').value;
        const email = forgotPasswordTab.querySelector('input[placeholder="Email"]').value;
        const password = forgotPasswordTab.querySelector('input[placeholder="Password"]').value;

        const res = await fetch('/api/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });

        const data = await res.json();
        if (res.ok) {
          alert('Đổi mật khẩu thành công!');
          forgotPasswordTab.classList.remove('active');
          loginTab.classList.add('active');
          formTitle.innerText = 'SIGN IN';
        } else {
          alert(data.message || 'Không tìm thấy người dùng!');
        }
      });

      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.style.opacity = 1;
        toast.style.pointerEvents = 'auto';

        // Tự ẩn sau 3 giây
        setTimeout(() => {
          toast.style.opacity = 0;
          toast.style.pointerEvents = 'none';
        }, 3000);
      }

      // ==== Station ====
      async function renderStations() {
        const stationList = document.getElementById('station-list');
        stationList.innerHTML = '';
        const res = await fetch('/api/stations');
        const stations = await res.json();
        stations.forEach(station => {
          const info = document.createElement('div');
          info.style.marginBottom = '10px';
          info.innerHTML = `<strong>${station.name}</strong><br>Capacity: ${station.max_capacity}<br>Current Occupation: ${station.current_occupation}`;
          stationList.appendChild(info);
        });
      }

      // ==== Room ====
      async function renderRoomDropdowns() {
        const sourceSelect = document.getElementById('source-room');
        const destSelect = document.getElementById('delivery-room');
        sourceSelect.innerHTML = '';
        destSelect.innerHTML = '';

        try {
          const res = await fetch('/api/rooms');
          if (!res.ok) throw new Error('Failed to fetch rooms');
          const rooms = await res.json();

          rooms.forEach(room => {
            const option1 = document.createElement('option');
            option1.value = option1.textContent = room;
            option1.style.color = '#000';
            option1.style.backgroundColor = '#fff';
            sourceSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = option2.textContent = room;
            option2.style.color = '#000';
            option2.style.backgroundColor = '#fff';
            destSelect.appendChild(option2);
          });
        } catch (err) {
          console.error('Lỗi khi lấy danh sách phòng:', err.message);
        }
      }

      // ==== Transfer Log ====
      async function addTransferLog() {
        const source = document.getElementById('source-room').value;
        const dest = document.getElementById('delivery-room').value;
        if (!source || !dest) return alert('Chọn cả 2 phòng');

        await fetch('/api/transfer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source, destination: dest })
        });

        loadLogs();
      }

      async function loadLogs() {
        const logBox = document.getElementById('transfer-log-output');
        logBox.innerHTML = '';
        const res = await fetch('/api/logs');
        const logs = await res.json();
        logs.forEach(log => {
          const div = document.createElement('div');
          div.textContent = `${new Date(log.timestamp).toLocaleString()}: ${log.source} → ${log.destination}`;
          logBox.appendChild(div);
        });
      }

      async function fetchArrivalStatus() {
        try {
          const res = await fetch('/api/location'); // hoặc '/logs'
          const text = await res.text();        // ví dụ: ✅ Đã đến vị trí số 4
          showToast(text);                      // ✅ Gọi toast thay vì alert
        } catch (err) {
          showToast('❌ Không thể nhận dữ liệu từ robot!');
        }
      }
      </script>
      
      <script>
        const socket = io();

        // socket.on('location-update', (location) => {
        //   showToast(`✅ Đã đến vị trí số ${location}`);
        // });
        socket.on('new-log', (log) => {
          const logBox = document.getElementById('transfer-log-output');
          const div = document.createElement('div');
          const time = new Date(log.timestamp).toLocaleString();
          div.textContent = `${time}: ${log.source} → ${log.destination}`;
          logBox.prepend(div); // Add new logs at the top
        });

        // Load initial logs
        window.onload = () => {
          loadLogs();
        };
      </script>

  </body>
</html>